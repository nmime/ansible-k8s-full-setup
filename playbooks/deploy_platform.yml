---
# Ansible Workflow Platform
# Complete automation for Kubernetes platform deployment
#
# Deploys full-stack Kubernetes platform including:
# - Hetzner Cloud Infrastructure
# - Kubernetes Cluster (via Kubespray)
# - Network Security (VPN + Firewalls)
# - Secrets Management (Vault + ESO)
# - Databases (PostgreSQL + MongoDB)
# - Storage (MinIO)
# - GitLab CE
# - ArgoCD (GitOps)
# - Observability (Monitoring + Logging)
# - Event-Driven Autoscaling (KEDA)

# Deployment sequence: infrastructure → network security → secrets → storage → databases → gitlab → gitops → observability → autoscaling

- name: Gather facts
  ansible.builtin.setup:

- name: Display deployment banner
  debug:
    msg:
      - "=========================================="
      - "  Ansible Kubernetes Platform Deployment"
      - "  Project: {{ project_name | default('k8s') }}"
      - "  Tier: {{ tier | default('medium') }}"
      - "=========================================="

- name: Check required environment variables
  assert:
    that:
      - "'HETZNER_API_TOKEN' in lookup('env', 'HOME') + '/.clouds/hcloud' or 'HETZNER_API_TOKEN' in lookup('env', 'HOME') + '/.config/hcloud'"
    fail_msg: "HETZNER_API_TOKEN environment variable not found. Please set it."
    quiet: false

# Step 1: Infrastructure
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: hetzner-infra
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"
    project_name: "{{ project_name | default('k8s') }}"

# Step 2: Network Security
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: network-security
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 3: Kubernetes Cluster
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-cluster-management
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 4: Secrets Management
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-secrets
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 5: Storage (MinIO)
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: minio-storage
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 6: Databases
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-databases
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 7: GitLab
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: gitlab-selfhosted
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 8: GitOps (ArgoCD)
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-gitops
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 9: Observability
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-observability
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Step 10: Autoscaling
- name: "{{ gitlab. }} role"
  ansible.builtin.include_role:
    name: k8s-autoscaling
    tasks_from: main.yml
  vars:
    tier: "{{ tier | default('medium') }}"

# Final deployment summary
- name: Display deployment completion summary
  debug:
    msg:
      - "=========================================="
      - "  Platform Deployment Complete"
      - "  Tier: {{ tier | default('medium') }}"
      - "  Project: {{ project_name | default('k8s') }}"
      - "=========================================="
      - "Services deployed:"
      - "  - Kubernetes Cluster with Cilium CNI"
      - "  - GitLab CE with CI/CD"
      - "  - ArgoCD (GitOps)"
      - "  - Grafana (Monitoring)"
      - "  - VictoriaMetrics + Loki (Log aggregation)"
      - "  - MinIO (Object Storage)"
      - "  - Vault (Secrets)"
      - "  - PostgreSQL Cluster"
      - "  - KEDA (Event autoscaling)"
      - "  - Headscale VPN"
      - "=========================================="
